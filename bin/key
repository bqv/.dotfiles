#!/bin/sh

if [[ $UID -eq 0 ]]; then
    sudo umount /tmp/cryptfs ||\
    sudo umount /tmp/cryptfs -f
    sudo cryptsetup luksClose socket
    clear
	echo Hey, I don\'t need root!
	exit 1
fi

mkdir -p /tmp/oldfs
sudo modprobe nbd
sudo qemu-nbd -c /dev/nbd0 VirtualBox/Linux/Linux.vdi
sudo kpartx -a /dev/nbd0
sleep 2
sudo mount /dev/mapper/nbd0p3 /tmp/oldfs
echo -n "Password: "
read -s PASS
echo -e "$PASS" | sudo cryptsetup luksOpen /tmp/oldfs/__active/tmp/... socket || exec sh $0
mkdir -p /tmp/cryptfs
sudo mount /dev/mapper/socket /tmp/cryptfs

PATH=".:$PATH"

(cd /tmp/cryptfs && clear && tcsh && clear)

sudo umount /tmp/cryptfs ||\
sudo umount /tmp/cryptfs -f
sudo cryptsetup luksClose socket
sudo umount /tmp/oldfs
clear
