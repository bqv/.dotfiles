#!/bin/sh

FDS=`ps ax | awk '/ppapi/{print $1}' | xargs -n 1 -I{} sudo lsof -p {} 2>/dev/null | grep "Pepper Data/Shockwave Flash" | awk '{print $2":"$4":"$9"#"$10"#"$11}'`

echo --
for l in $FDS
do
	PID=`echo $l|awk -F":" '{print $1}'`
	FD=`echo $l|awk -F":" '{print $2}'|sed 's/.$//'`
	OLD_NAME=`echo $l|awk -F":" '{print $3}'|sed 's/#/ /g'`
	FILE="/proc/$PID/fd/$FD"
	if [[ $1 == "cp" ]] || [[ $1 == "-cp" ]] || [[ $1 == "--cp" ]]
	then
		SIG=$(sed 's/^.\+\.\(......\)$/\1/' <<< $OLD_NAME)
        TIME=`date +%s | cut -b 5-`
        NEW_NAME="Flash${TIME}XX${SIG}"
		echo Copying $FILE to $NEW_NAME
        sudo pv $FILE > $NEW_NAME
	elif [[ $1 == "ls" ]] || [[ $1 == "-ls" ]] || [[ $1 == "--ls" ]]
	then
		SZ=`sudo du -bL $FILE | cut -f 1`
		echo Found: $FILE \(${SZ}b\)
	elif [[ $USER == "root" ]]
	then
		echo Broadcasting "$FILE ($OLD_NAME)"
		SZ=`sudo du -bL $FILE | cut -f 1`
		sudo nice --10 mpv -fs $FILE $@;
		NSZ=`sudo du -bL $FILE | cut -f 1`
		while [[ $SZ -lt $NSZ ]]
		do
			SZ=$NSZ
			sudo nice --10 mpv -fs $FILE $@;
			NSZ=`sudo du -bL $FILE | cut -f 1`
		done
	else
		echo Playing "$FILE ($OLD_NAME)"
		SZ=`sudo du -bL $FILE | cut -f 1`
		sudo mpv -fs $FILE $@;
		NSZ=`sudo du -bL $FILE | cut -f 1`
		while [[ $SZ -lt $NSZ ]]
		do
			SZ=$NSZ
			sudo mpv -fs $FILE $@;
			NSZ=`sudo du -bL $FILE | cut -f 1`
		done
	fi
	echo --
done
