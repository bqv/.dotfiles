#!/bin/sh

COWFILE="$HOME/.changes.cow"

HDD="$(losetup -f)"
losetup -r $HDD /dev/sda
COW="$(losetup -f)"
fallocate -l 2G $COWFILE || { losetup -d $HDD; exit 1; }
losetup $COW $COWFILE || { rm $COWFILE; losetup -d $HDD; exit 1; }
rm $COWFILE

trap "{ dmsetup remove sbox_$$; losetup -d $HDD $COW; exit 2; }" EXIT SIGINT SIGTERM SIGQUIT
set -x

dmsetup create sbox_$$ --table "0 $(blockdev --getsz /dev/sda) snapshot $HDD $COW N 1"
qemu-system-x86_64 -boot c -hda /dev/mapper/sbox_$$

{set +x;}2>/dev/null
exit 0
